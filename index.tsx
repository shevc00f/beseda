import React, { useState, useMemo, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { GoogleGenAI } from "@google/genai";

type ApiProvider = 'local' | 'gemini';

const API_CONFIG: Record<ApiProvider, { name: string; keyLink?: string; placeholder?: string; }> = {
    local: {
        name: 'Встроенный',
    },
    gemini: {
        name: 'Gemini',
        keyLink: 'https://aistudio.google.com/app/apikey',
        placeholder: 'Введите ваш Gemini API ключ...'
    }
};

const PREDEFINED_SAFETY_CONTACTS = [
    "При работе с ручным электроинструментом всегда проверяйте целостность кабеля и корпуса. Использование поврежденного инструмента может привести к поражению электрическим током. Перед каждым использованием проводите визуальный осмотр. Не используйте инструмент, если заметили трещины, сколы или оголенные провода. Немедленно сообщите о неисправности вашему руководителю.",
    "Передвигаясь по территории цеха, будьте внимательны и смотрите под ноги. На полу могут быть разливы масла, воды или другие скользкие вещества, которые могут привести к падению. Всегда используйте обозначенные пешеходные дорожки. Если вы заметили разлив, не проходите мимо – обозначьте опасное место и сообщите службе уборки. Ваша бдительность помогает предотвратить травмы.",
    "Во время подъема или спуска по лестнице всегда держитесь за перила. Не носите в руках предметы, которые мешают свободно держаться или закрывают обзор. Разговоры по мобильному телефону во время движения по лестнице строго запрещены. Один неверный шаг может привести к серьезному падению и травме. Сосредоточьтесь на движении для обеспечения своей безопасности.",
    "Никогда не снимайте защитные кожухи с работающего оборудования. Они установлены для предотвращения попадания в движущиеся части механизмов. Даже если кажется, что это ускорит работу, риск получения тяжелой травмы несоизмеримо выше. Доступ к механизмам разрешен только после полной остановки оборудования и его блокировки. Берегите свои руки и жизнь.",
    "Использование средств индивидуальной защиты (СИЗ) является обязательным на производственной площадке. Каска, защитные очки и специальная обувь защищают вас от множества рисков. Не пренебрегайте этими правилами, даже если выполняете 'быструю' задачу. Большинство несчастных случаев происходит именно из-за неоправданной спешки и игнорирования базовых требований безопасности. Ваше здоровье – ваша главная ценность.",
    "При использовании кухонного ножа всегда режьте в направлении от себя. Держите пальцы подальше от лезвия и используйте устойчивую разделочную доску. Острый нож безопаснее тупого, так как требует меньше усилий.",
    "Никогда не оставляйте без присмотра сковороду с разогретым маслом. Масло может воспламениться за считанные секунды. Если произошло возгорание, накройте сковороду крышкой или мокрой тканью, но никогда не лейте воду.",
    "Не перегружайте электрические розетки, включая в один удлинитель несколько мощных приборов. Это может привести к перегреву и короткому замыканию. Распределяйте нагрузку равномерно по разным розеткам.",
    "Никогда не смешивайте бытовые чистящие средства, особенно содержащие хлор (отбеливатель) и аммиак. Их реакция выделяет токсичный газ, опасный для дыхательных путей. Всегда работайте в проветриваемом помещении.",
    "При использовании стремянки убедитесь, что она стоит на ровной и устойчивой поверхности. Никогда не становитесь на самую верхнюю ступеньку. Сохраняйте три точки опоры: две ноги и одна рука.",
    "Поднимая тяжести, сгибайте ноги в коленях, а не спину. Держите груз как можно ближе к телу. Это значительно снижает нагрузку на позвоночник и предотвращает травмы спины.",
    "Регулярно проверяйте и тестируйте дымовые извещатели в вашем доме. Меняйте батарейки как минимум раз в год. Раннее обнаружение дыма может спасти вашу жизнь и имущество в случае пожара.",
    "При работе за компьютером настройте эргономику рабочего места. Верхний край монитора должен быть на уровне глаз, а локти согнуты под углом 90 градусов. Делайте регулярные перерывы, чтобы размяться.",
    "Во время вождения полностью откажитесь от использования мобильного телефона. Отвлечение на звонок или сообщение даже на несколько секунд может привести к серьезной аварии. Используйте гарнитуру 'hands-free' только в крайнем случае.",
    "Перед началом работы с электроинструментом всегда надевайте защитные очки. Мелкая стружка, осколки или пыль могут нанести необратимый вред вашим глазам. Это простое правило защитит ваше зрение.",
    "Храните легковоспламеняющиеся жидкости, такие как бензин или растворители, в специальных герметичных канистрах. Держите их вдали от источников тепла и открытого огня, обеспечив хорошую вентиляцию.",
    "Содержите рабочее место и проходы в чистоте. Разбросанные инструменты или мусор являются частой причиной спотыканий и падений. Убирайте все на свои места после завершения работы.",
    "При работе с газонокосилкой никогда не пытайтесь очистить забившийся желоб для выброса травы руками. Всегда сначала заглушите двигатель и дождитесь полной остановки лезвий.",
    "Не используйте электроприборы, если у них поврежден шнур питания. Оголенные провода представляют смертельную опасность поражения током. Отдайте такой прибор в ремонт или замените шнур.",
    "При работе в шумной среде, например, с циркулярной пилой или перфоратором, всегда используйте средства защиты слуха. Длительное воздействие громкого шума может привести к необратимой потере слуха.",
    "Не оставляйте открытыми ящики столов или шкафов. Кто-то может не заметить их и получить травму при столкновении. Выработайте привычку закрывать их сразу после использования.",
    "Убедитесь, что все ковры и коврики в доме имеют нескользящую подложку. Особенно это важно в ванной комнате и на кухне, где полы могут быть мокрыми. Это простое средство предотвращает множество падений.",
    "Никогда не используйте металлические предметы в микроволновой печи. Это может вызвать искрение и повредить прибор, а в худшем случае — привести к возгоранию. Используйте только предназначенную для этого посуду.",
    "При работе на высоте убедитесь, что леса или подмости установлены надежно. Используйте страховочные системы, если работаете на высоте более 1.8 метра. Никогда не работайте в одиночку.",
    "Знайте, где находится главный выключатель электроэнергии (автомат) в вашем доме или на рабочем месте. В случае ЧП вы должны уметь быстро обесточить помещение.",
    "При замене лампочки всегда сначала отключайте питание на выключателе или автомате. Никогда не меняйте лампочку, если патрон под напряжением. Это убережет вас от удара током.",
    "При использовании химикатов для сада всегда надевайте перчатки и защитную одежду. Внимательно читайте инструкцию и не превышайте рекомендованную дозировку. Избегайте работы в ветреную погоду.",
    "Во время грозы держитесь подальше от окон и электроприборов. Не пользуйтесь стационарным телефоном. Удар молнии может пройти по проводам и коммуникациям на большое расстояние.",
    "Никогда не оставляйте без присмотра включенный утюг. Это одна из самых частых причин бытовых пожаров. Даже если есть функция автоотключения, не стоит на нее полностью полагаться.",
    "Если вы почувствовали запах газа, немедленно откройте окна, перекройте газ и вызовите аварийную службу с безопасного расстояния. Не включайте свет и не используйте электроприборы.",
    "При парковке автомобиля на уклоне всегда ставьте его на ручной тормоз и выворачивайте колеса в сторону бордюра. Это предотвратит скатывание машины в случае отказа тормоза.",
    "Не работайте в одиночку в замкнутых пространствах, таких как колодцы или цистерны. В таких местах может скапливаться опасный газ или быть недостаток кислорода. Обязательно нужен наблюдающий снаружи.",
    "При работе с болгаркой (УШМ) убедитесь, что защитный кожух установлен правильно. Всегда держите инструмент двумя руками. Не используйте диски, не предназначенные для вашего инструмента.",
    "Будьте осторожны с горячими напитками рядом с детьми. Ожоги от чая или кофе могут быть очень серьезными. Ставьте кружки подальше от края стола, куда может дотянуться ребенок.",
    "Устанавливая мебель, надежно закрепляйте высокие и неустойчивые предметы (шкафы, стеллажи) к стене. Это предотвратит их опрокидывание, которое может привести к тяжелым травмам.",
    "Во время гололеда передвигайтесь медленно, мелкими шагами, наступая на всю подошву. Пожилым людям рекомендуется использовать специальные насадки на обувь против скольжения.",
    "Не пытайтесь самостоятельно тушить загоревшийся электроприбор водой. Обесточьте прибор и используйте порошковый огнетушитель, либо накройте его плотной тканью, перекрыв доступ кислорода.",
    "При работе с резаком для бумаги в офисе используйте его только по назначению и держите пальцы подальше от лезвия. После использования фиксируйте лезвие в безопасном положении.",
    "Во время уборки снега с крыши соблюдайте особую осторожность и используйте страховочный трос. Никогда не работайте в одиночку. Помните, что под слоем снега может быть лед.",
    "Прежде чем начать копать землю, убедитесь в отсутствии подземных коммуникаций (кабели, трубы). Свяжитесь с соответствующими службами для получения плана, чтобы избежать повреждений и несчастных случаев.",
    "При использовании бензопилы всегда надевайте защитный щиток для лица и перчатки. Крепко держите пилу обеими руками и будьте готовы к обратному удару. Никогда не пилите кончиком шины.",
    "Не храните бытовую химию в доступном для детей месте. Используйте шкафы с замками. Никогда не переливайте химикаты в бутылки из-под напитков, чтобы избежать случайного отравления.",
    "При обнаружении утечки воды немедленно перекройте главный вентиль водоснабжения. Это предотвратит затопление. Заранее узнайте, где он находится в вашей квартире или доме.",
    "Будьте осторожны, открывая горячую крышку кастрюли. Открывайте ее 'от себя', чтобы пар не ошпарил вам лицо и руки. Используйте прихватки для защиты от ожогов.",
    "Перед тем как сесть за руль, убедитесь, что под педалями нет посторонних предметов, например, бутылки с водой или коврика. Они могут заблокировать педаль в самый неподходящий момент.",
    "При работе с клеем или краской всегда обеспечивайте хорошую вентиляцию. Пары многих химических веществ токсичны и могут вызвать головокружение или отравление. Лучше всего работать на открытом воздухе.",
    "Никогда не оставляйте маленьких детей одних в ванной комнате даже на мгновение. Ребенок может утонуть в небольшом количестве воды за очень короткое время. Всегда будьте рядом.",
    "При сварке всегда используйте сварочную маску с подходящим светофильтром. Ультрафиолетовое излучение от дуги может вызвать сильный ожог глаз. Также защищайте открытые участки кожи от искр.",
    "Если вам нужно принять лекарство в темноте, всегда сначала включите свет. Приняв по ошибке не то лекарство или не ту дозу, можно нанести серьезный вред здоровью. Не полагайтесь на ощупь.",
    "Не садитесь за руль в уставшем или сонном состоянии. Усталость замедляет реакцию так же, как и алкоголь. Если чувствуете сонливость, остановитесь и отдохните, прежде чем продолжить путь.",
    "Не пытайтесь самостоятельно ремонтировать сложную бытовую технику, если не обладаете нужными знаниями. Неправильное вмешательство может привести к поражению током или пожару. Доверьте ремонт профессионалам.",
    "Убедитесь, что аптечка первой помощи укомплектована и находится в доступном месте как дома, так и на работе. Регулярно проверяйте сроки годности лекарств. Знание, где она находится, экономит драгоценное время.",
    "При общении с незнакомыми животными, особенно бездомными, не делайте резких движений и не пытайтесь их погладить. Они могут испугаться и проявить агрессию. Научите этому правилу своих детей.",
    "Во время зимних прогулок одевайтесь многослойно. Это позволяет лучше сохранять тепло и при необходимости снять один из слоев, чтобы не перегреться. Особое внимание уделяйте защите головы, рук и ног от обморожения.",
    "При использовании блендера убедитесь, что крышка плотно закрыта, прежде чем включать его. Никогда не просовывайте руки или предметы внутрь во время работы.",
    "Используйте нескользящие коврики в ванной и душе, чтобы предотвратить падения на мокром полу.",
    "Не оставляйте свечи без присмотра и тушите их перед сном или выходом из дома.",
    "Никогда не используйте электроприборы с поврежденными шнурами. Это может привести к удару током или пожару.",
    "Провода и кабели держите убранными, чтобы избежать спотыкания. Используйте кабельные органайзеры.",
    "Не загромождайте проходы и аварийные выходы коробками или мебелью.",
    "Правильно регулируйте свое кресло, чтобы избежать болей в спине. Ваши ступни должны ровно стоять на полу.",
    "Всегда пристегивайтесь ремнем безопасности, даже при коротких поездках. Это может спасти вам жизнь.",
    "Соблюдайте безопасную дистанцию до впереди идущего автомобиля. Это даст вам время для реакции.",
    "Никогда не садитесь за руль в утомленном состоянии. Усталость замедляет реакцию.",
    "Всегда надевайте каску на строительной площадке для защиты от падающих предметов.",
    "Перед использованием лестницы убедитесь, что она устойчива и установлена на ровной поверхности.",
    "При работе с химикатами всегда надевайте защитные перчатки и очки.",
    "Храните химикаты в оригинальной упаковке с этикетками, вдали от детей и продуктов питания.",
    "Знайте расположение огнетушителей и пути эвакуации в вашем здании.",
    "Не курите в постели. Это одна из самых частых причин бытовых пожаров.",
    "В случае пореза промойте рану чистой водой и наложите стерильную повязку.",
    "При ожоге охлаждайте пораженный участок холодной водой не менее 10-15 минут.",
    "Используйте сложные и уникальные пароли для разных аккаунтов.",
    "Не делитесь личной информацией (адрес, номер телефона) с незнакомцами в интернете.",
    "Сообщите кому-нибудь о своем маршруте, особенно если отправляетесь в поход в одиночку.",
    "Будьте бдительны в людных местах, чтобы избежать карманных краж. Держите ценные вещи при себе.",
    "Тщательно мойте руки с мылом до и после приготовления пищи.",
    "Не храните сырое мясо рядом с готовыми к употреблению продуктами, чтобы избежать перекрестного заражения.",
    "Установите заглушки на электрические розетки, если в доме есть маленькие дети.",
    "Никогда не оставляйте маленьких детей без присмотра у воды, будь то ванна, бассейн или водоем.",
    "Всегда делайте разминку перед тренировкой, чтобы подготовить мышцы и избежать травм.",
    "При катании на велосипеде, скейтборде или роликах всегда надевайте шлем.",
    "При работе с пилой или шлифовальной машиной всегда надевайте защитные очки.",
    "Держите рабочее место в чистоте, чтобы избежать спотыкания о инструменты или материалы.",
    "Надевайте перчатки при работе в саду для защиты от порезов, заноз и бактерий в почве.",
    "Очищайте тротуары и ступеньки от снега и льда, чтобы предотвратить падения.",
    "Используйте солнцезащитный крем и носите головной убор, чтобы защититься от солнечных ожогов и теплового удара.",
    "Не беспокойте животное, когда оно ест или спит. Это может вызвать агрессивную реакцию.",
    "Стоя в автобусе или метро, всегда держитесь за поручень.",
    "Находясь в толпе, определите ближайшие выходы на случай экстренной ситуации.",
    "Берите с собой достаточно воды, даже если поход кажется коротким, чтобы избежать обезвоживания.",
    "Никогда не плавайте в одиночку в незнакомых водоемах.",
    "Не прикасайтесь к электроприборам мокрыми руками.",
    "Регулярно очищайте фильтр сушильной машины от ворса, чтобы предотвратить возгорание.",
    "Убедитесь, что вентиляционные отверстия отопительных приборов не заблокированы.",
    "Регулярно проверяйте давление в шинах. Правильное давление улучшает управляемость и экономит топливо.",
    "Делайте короткие перерывы, чтобы дать глазам отдохнуть от экрана компьютера.",
    "Готовьте пищу до безопасной внутренней температуры, особенно мясо и птицу.",
    "Храните лекарства в недоступном для детей месте, желательно в запертом шкафчике.",
    "Читайте инструкции к инструментам и материалам перед их использованием.",
    "При подъеме тяжестей просите о помощи. Не переоценивайте свои силы.",
    "Всегда сообщайте о любой опасной ситуации или неисправности вашему руководителю.",
    "Используйте светоотражатели и фонари при езде на велосипеде в темное время суток.",
    "Не бегите по лестнице и не перепрыгивайте через ступеньки.",
    "Держите ручки кастрюль и сковородок повернутыми к центру плиты, чтобы случайно их не задеть.",
    "Устанавливайте гриль на открытом воздухе, вдали от стен дома и легковоспламеняющихся материалов.",
    "Имейте под рукой фонарик с рабочими батарейками на случай отключения электричества. Свечи могут быть опасны.",
    "Всегда запирайте двери и окна, даже если уходите ненадолго.",
    "Держите список экстренных номеров (скорая, полиция, пожарная) на видном месте.",
    "В дождь или туман снижайте скорость и включайте фары.",
    "Знайте и соблюдайте правила техники безопасности на вашем рабочем месте.",
    "Никогда не используйте химикаты в непроветриваемом помещении.",
    "Научите детей своему полному имени, адресу и номеру телефона.",
    "Убедитесь, что комнатные растения не ядовиты для ваших домашних животных.",
    "Не игнорируйте боль. Если что-то болит, обратитесь к врачу.",
    "Пейте достаточно воды в течение дня, особенно в жаркую погоду или при физических нагрузках.",
    "Обеспечьте себе достаточный сон. Недостаток сна влияет на концентрацию и принятие решений.",
    "Если вы чувствуете стресс или тревогу, поговорите с кем-то, кому доверяете.",
    "Будьте осторожны с фишинговыми письмами. Не переходите по подозрительным ссылкам.",
    "Никогда не стойте и не проходите под поднятым грузом вилочного погрузчика.",
    "Соблюдайте скоростной режим при движении на технике по складу.",
    "Убедитесь в отсутствии легковоспламеняющихся материалов в зоне проведения сварочных работ.",
    "Всегда знайте, где находится аварийный душ и станция для промывки глаз в лаборатории.",
    "Немедленно убирайте разливы на полу кухни, чтобы предотвратить скольжение.",
    "Используйте правильную технику для подъема коробок, чтобы избежать травм спины.",
    "Всегда мойте руки до и после контакта с пациентом.",
    "Убедитесь, что на борту достаточно спасательных жилетов для всех пассажиров.",
    "Тушите костер полностью перед тем, как покинуть стоянку или лечь спать.",
    "Будьте осторожны с рыболовными крючками, смотрите, куда забрасываете удочку.",
    "Катайтесь по трассам, соответствующим вашему уровню подготовки.",
    "Возвращайте гантели и диски на место после использования, чтобы никто о них не споткнется.",
    "Бегайте навстречу движению транспорта, если нет тротуара, чтобы видеть приближающиеся машины.",
    "Перед поездкой задним ходом всегда оборачивайтесь и проверяйте 'слепые' зоны.",
    "Не становитесь на вращающиеся стулья, чтобы достать что-то с высоты. Используйте стремянку.",
    "Проверяйте срок годности продуктов перед употреблением.",
    "Разработайте и отработайте с семьей план эвакуации на случай пожара.",
    "Не перегружайте гирляндами одну розетку и выключайте их на ночь.",
    "Обращайте внимание на свое окружение и доверяйте своей интуиции.",
    "Во время сильного ветра держитесь подальше от деревьев и линий электропередач.",
    "Если вы в помещении во время землетрясения, укройтесь под прочным столом.",
    "Никогда не пытайтесь проехать или пройти через затопленный участок дороги.",
    "Не носите свободную одежду или украшения, которые могут попасть в движущиеся части станков.",
    "Перед входом в замкнутое пространство всегда проверяйте состав воздуха.",
    "Убедитесь, что строительные леса собраны правильно и стоят на прочном основании.",
    "Никогда не входите в траншею глубиной более 1.5 метра без укрепления стенок.",
    "Используйте средства защиты слуха при работе с шумным оборудованием.",
    "При работе, создающей пыль, используйте респиратор для защиты легких.",
    "Водители, используйте солнцезащитные козырьки, чтобы избежать ослепления солнцем.",
    "При работе сидя делайте короткие перерывы на растяжку каждый час.",
    "Знайте, где находятся ближайшие источники питьевой воды на рабочем месте.",
    "Не бойтесь сообщать о небезопасных условиях. Это защищает всех.",
    "Убедитесь, что ваши средства индивидуальной защиты (СИЗ) подходят по размеру и находятся в хорошем состоянии.",
    "Для уборки химических разливов используйте специальные абсорбенты, а не обычные тряпки.",
    "Перед ремонтом оборудования всегда применяйте процедуру блокировки и маркировки (LOTO).",
    "Будьте в курсе окружающих вас опасностей. Предвидение — ключ к безопасности.",
    "Используйте инструмент только по его прямому назначению.",
    "Никогда не используйте воду для тушения масляного пожара. Накройте его крышкой.",
    "Сохраняйте три точки опоры при подъеме или спуске по лестнице (две ноги и одна рука, или наоборот).",
    "Распознавайте признаки усталости у себя и коллег. Уставший работник — небезопасный работник.",
    "Чистое рабочее место — безопасное рабочее место. Убирайте мусор и ненужные предметы.",
    "Убедитесь, что аварийные выходы всегда свободны и не заблокированы.",
    "Научитесь пользоваться огнетушителем. Помните аббревиатуру ПАСП (Pull, Aim, Squeeze, Sweep).",
    "Смотрите, куда идете, и сообщайте о мокрых полах или неровностях.",
    "Перед сменой полосы всегда проверяйте 'слепую' зону.",
    "Будьте осторожны с горячими поверхностями и паром. Используйте предупреждающие знаки.",
    "Утилизируйте лезвия и другие острые предметы в специальных контейнерах.",
    "Закрепляйте газовые баллоны в вертикальном положении, чтобы предотвратить их падение.",
    "Никогда не ходите под подвешенным грузом. Соблюдайте безопасную зону.",
    "Присматривайте друг за другом. Безопасность — это общая ответственность.",
    "Корректируйте свою работу и вождение в соответствии с погодными условиями.",
    "Знайте, где находится аптечка первой помощи, и что в ней содержится.",
    "Не используйте мобильный телефон при ходьбе по лестницам или в зонах движения транспорта.",
    "Четко общайтесь с коллегами, особенно при выполнении совместных опасных работ.",
    "Начинайте каждый день с мыслью о безопасности. Ваша главная цель — вернуться домой здоровым.",
    "Создавайте резервные копии важных данных регулярно. Храните копии в отдельном, безопасном месте, чтобы защититься от потери данных.",
    "Не игнорируйте обновления программного обеспечения. Они часто содержат важные исправления безопасности, защищающие от новых угроз.",
    "Будьте осторожны с общественными Wi-Fi сетями. Не вводите пароли и не заходите в онлайн-банкинг в таких сетях.",
    "Используйте двухфакторную аутентификацию для важных аккаунтов. Это создает дополнительный уровень защиты, даже если ваш пароль украден.",
    "Если вы чувствуете эмоциональное выгорание, поговорите с руководителем. Ваше психическое здоровье так же важно, как и физическое.",
    "Делайте короткие перерывы в течение рабочего дня, чтобы отвлечься и восстановить концентрацию. Это помогает снизить стресс.",
    "Не бойтесь просить о помощи, если чувствуете, что не справляетесь с нагрузкой. Командная работа — ключ к здоровой рабочей среде.",
    "Мойте овощи и фрукты перед употреблением, даже если собираетесь их чистить. Бактерии с кожуры могут попасть на мякоть.",
    "Используйте отдельные разделочные доски для сырого мяса и готовых продуктов, чтобы предотвратить перекрестное заражение.",
    "Готовьте пищу до рекомендуемой внутренней температуры. Используйте кухонный термометр для точности.",
    "Никогда не оставляйте приготовленную пищу при комнатной температуре более двух часов. Убирайте остатки в холодильник.",
    "Перед поездкой за границу изучите местные законы и обычаи. Это поможет избежать неприятных ситуаций.",
    "Сделайте копии важных документов (паспорт, виза) и храните их отдельно от оригиналов.",
    "Сообщите семье или друзьям о своем маршруте и планах на поездку. Поддерживайте регулярный контакт.",
    "В жаркую погоду носите легкую, светлую одежду и головной убор. Избегайте прямых солнечных лучей в полдень.",
    "Никогда не оставляйте детей или животных в припаркованной машине в теплую погоду. Температура в салоне может быстро стать смертельной.",
    "Зимой носите многослойную одежду и нескользящую обувь. Защищайте открытые участки кожи от обморожения.",
    "При работе с пневматическим инструментом убедитесь, что шланги надежно закреплены. Внезапный отрыв шланга под давлением опасен.",
    "Никогда не направляйте струю сжатого воздуха на себя или на коллег. Это может привести к серьезным травмам, включая эмболию.",
    "Перед началом сварочных работ уберите легковоспламеняющиеся материалы. Искры могут разлетаться на несколько метров.",
    "Используйте защитные экраны или шторы при сварке, чтобы защитить окружающих от яркого света и УФ-излучения.",
    "При работе с абразивными кругами проверяйте их на наличие трещин перед установкой. Поврежденный круг может разлететься.",
    "Не превышайте максимальную допустимую скорость вращения, указанную на абразивном диске. Использование неподходящего диска опасно.",
    "При работе на конвейере не носите свободную одежду, соберите длинные волосы. Это предотвратит их затягивание в движущиеся части.",
    "Знайте, где находятся кнопки аварийной остановки на оборудовании. В нештатной ситуации это может спасти жизнь.",
    "При работе с грузоподъемными механизмами никогда не стойте под поднятым грузом. Это самая опасная зона.",
    "Перед подъемом груза убедитесь, что стропы закреплены правильно и груз сбалансирован. Неправильная строповка ведет к падению груза.",
    "При работе с гидравликой регулярно проверяйте шланги на утечки и износ. Жидкость под высоким давлением может пробить кожу.",
    "Не используйте пальцы для проверки утечек в гидравлических системах. Используйте картон или дерево, чтобы найти место утечки.",
    "Храните газовые баллоны в вертикальном положении и надежно закрепленными. Падение баллона может повредить вентиль.",
    "Никогда не используйте масло или смазку на вентилях кислородных баллонов. Кислород под давлением может вызвать самовозгорание.",
    "При работе в ограниченном пространстве используйте газоанализатор для проверки воздуха перед входом.",
    "Работа в ограниченном пространстве требует наличия наблюдающего снаружи и плана спасения на случай ЧС.",
    "При работе с химикатами читайте паспорт безопасности (SDS), чтобы знать о рисках и мерах предосторожности.",
    "Используйте соответствующую вентиляцию при работе с летучими химикатами, чтобы избежать вдыхания паров.",
    "В случае попадания химиката на кожу или в глаза, немедленно промойте участок большим количеством воды в течение 15 минут.",
    "Не ешьте, не пейте и не курите в местах, где используются или хранятся химические вещества.",
    "Отрегулируйте высоту стула так, чтобы бедра были параллельны полу, а ступни ровно стояли на полу.",
    "Расположите монитор на расстоянии вытянутой руки. Верхний край экрана должен быть на уровне глаз или чуть ниже.",
    "Используйте отдельную клавиатуру и мышь при долгой работе с ноутбуком для правильного положения рук.",
    "Каждые 20 минут делайте 20-секундный перерыв, чтобы посмотреть на объект на расстоянии 6 метров (правило '20-20-20').",
    "Не кладите клавиатуру слишком близко к краю стола. Оставьте место для отдыха запястий.",
    "Избегайте беспорядка на рабочем столе. Это снижает риск опрокидывания предметов или повреждения оборудования.",
    "Не используйте поврежденные офисные стулья. Неисправный механизм или сломанные колесики могут привести к падению.",
    "Будьте осторожны с горячими напитками на рабочем месте. Используйте кружки с крышками.",
    "Не перегружайте верхние полки шкафов тяжелыми предметами. Храните тяжелые вещи на нижних полках.",
    "Будьте внимательны при ходьбе по офису, особенно в зонах с интенсивным движением. Не читайте на ходу.",
    "Установите детекторы угарного газа (CO), если у вас есть газовые приборы, камин или гараж.",
    "Разработайте и отработайте план эвакуации при пожаре для вашей семьи. Определите два выхода из каждой комнаты.",
    "Никогда не оставляйте работающие электронагреватели без присмотра, особенно рядом с мебелью или шторами.",
    "Очищайте ворсовый фильтр в сушильной машине после каждой загрузки. Скопление ворса — частая причина пожаров.",
    "При использовании гриля устанавливайте его на безопасном расстоянии от дома, деревьев и горючих материалов.",
    "Никогда не используйте угольный гриль или генераторы внутри помещения. Они выделяют смертельный угарный газ.",
    "Принимая лекарства, всегда следуйте инструкции и дозировке. Не занимайтесь самолечением.",
    "Храните все лекарства в оригинальной упаковке, чтобы избежать путаницы. Особенно это важно для пожилых.",
    "При выходе из дома всегда проверяйте, выключены ли плита, утюг и другие нагревательные приборы.",
    "Если вы уезжаете надолго, перекройте воду и газ, чтобы предотвратить утечки и аварии.",
    "Не делитесь планами об отпуске в соцсетях, пока не вернетесь. Это может привлечь грабителей.",
    "Установите хорошее освещение у входа в дом. Это отпугивает злоумышленников.",
    "Перед использованием новой бытовой техники всегда читайте инструкцию по эксплуатации.",
    "Не пытайтесь самостоятельно чинить микроволновую печь. Даже в отключенном состоянии она может содержать опасный заряд.",
    "Будьте осторожны с острыми краями открытых консервных банок. Они могут нанести глубокий порез.",
    "При уборке разбитого стекла используйте совок и щетку, а мелкие осколки соберите влажной бумажной салфеткой.",
    "Перед каждой поездкой проверяйте исправность фар, стоп-сигналов и поворотников. Быть видимым на дороге важно.",
    "Регулярно проверяйте давление в шинах. Неправильное давление ухудшает управляемость и увеличивает тормозной путь.",
    "Никогда не управляйте автомобилем в состоянии алкогольного или наркотического опьянения.",
    "Соблюдайте скоростной режим. Превышение скорости — одна из главных причин серьезных ДТП.",
    "Всегда пристегивайтесь ремнем безопасности и убедитесь, что все пассажиры пристегнуты.",
    "Используйте детские автокресла, соответствующие возрасту и весу ребенка.",
    "Избегайте агрессивного вождения: резких перестроений, 'подрезаний', несоблюдения дистанции.",
    "В условиях плохой видимости (туман, дождь, снег) снижайте скорость и увеличивайте дистанцию.",
    "Будьте особенно внимательны на перекрестках и пешеходных переходах.",
    "Перед тем как открыть дверь припаркованного автомобиля, посмотрите в зеркало заднего вида.",
    "Держите в автомобиле аптечку, огнетушитель и знак аварийной остановки. Знайте, как ими пользоваться.",
    "Если ваш автомобиль сломался на дороге, включите аварийную сигнализацию и съезжайте на обочину.",
    "При замене колеса убедитесь, что автомобиль стоит на ровной поверхности и на ручном тормозе.",
    "Не оставляйте ценные вещи на видном месте в салоне автомобиля. Это провоцирует кражу.",
    "Будьте осторожны при движении задним ходом. Смотрите в зеркала и оборачивайтесь.",
    "Перед началом работы на новом оборудовании пройдите соответствующее обучение и инструктаж.",
    "Не работайте, если вы больны или принимаете лекарства, влияющие на концентрацию. Сообщите об этом руководителю.",
    "При обнаружении любой неисправности оборудования немедленно прекратите работу и сообщите об этом.",
    "Убедитесь, что вы знаете, как правильно и безопасно остановить оборудование в экстренной ситуации.",
    "Не носите кольца, браслеты или другие украшения, которые могут зацепиться за движущиеся части машин.",
    "Если вы не уверены в безопасности операции, остановитесь и проконсультируйтесь с руководителем.",
    "При работе с лазерами никогда не смотрите прямо в луч и используйте соответствующие защитные очки.",
    "Не загромождайте доступ к электрощитам, пожарным гидрантам и огнетушителям.",
    "Сообщайте о всех, даже незначительных, травмах. Своевременная помощь может предотвратить осложнения.",
    "Участвуйте в тренингах по безопасности и регулярно освежайте свои знания.",
    "Поддерживайте позитивное отношение к безопасности. Ваше поведение влияет на коллег.",
    "При работе с ручным инструментом убедитесь, что рукоятки не скользкие и находятся в хорошем состоянии.",
    "Используйте подходящий инструмент для каждой задачи. Импровизация может привести к травме или поломке.",
    "Переносите острые инструменты (ножи, стамески) лезвием вниз и никогда не кладите их в карман.",
    "При работе с вилочным погрузчиком двигайтесь с опущенными вилами, когда не перевозите груз.",
    "Никогда не перевозите людей на вилах или на грузе погрузчика.",
    "Подавайте звуковой сигнал на перекрестках и в местах с ограниченной видимостью при движении на погрузчике.",
    "Не блокируйте открытыми двери, предназначенные для противопожарной защиты.",
    "Изучите план эвакуации вашего здания и знайте расположение нескольких выходов.",
    "Во время эвакуации не пользуйтесь лифтом, спускайтесь по лестнице.",
    "Сообщайте о любых потенциальных опасностях, которые вы заметили, даже если они не касаются вашей работы напрямую.",
    "Не отвлекайте коллег, когда они выполняют опасную работу. Разговоры могут подождать.",
    "При работе с компьютером периодически выполняйте упражнения для кистей рук, чтобы предотвратить туннельный синдром.",
    "Никогда не ешьте и не пейте за рабочим столом с клавиатурой, чтобы избежать короткого замыкания при проливании жидкости.",
    "Убедитесь, что все кабели на вашем рабочем месте аккуратно уложены и не создают опасности споткнуться.",
    "Перед уходом с работы выключайте все электроприборы, которые не должны работать постоянно.",
    "Будьте особенно осторожны в 'слепых зонах' крупных транспортных средств (грузовиков, автобусов). Водитель может вас не видеть.",
    "При езде на велосипеде используйте шлем и яркую одежду, чтобы быть заметнее на дороге.",
    "Переходите дорогу только на пешеходных переходах и на зеленый свет, убедившись, что машины остановились.",
    "Не слушайте громкую музыку в наушниках при ходьбе по улице или езде на велосипеде. Вы должны слышать окружающие звуки.",
    "При выходе из автобуса или такси выходите на сторону тротуара.",
    "Никогда не пытайтесь обогнать справа транспорт, который собирается поворачивать направо.",
    "При работе с источниками ионизирующего излучения строго соблюдайте принципы защиты временем, расстоянием и экранированием.",
    "Всегда носите индивидуальный дозиметр при работе в радиационно-опасной зоне.",
    "Не допускайте разгерметизации контейнеров с радиоактивными веществами.",
    "После работы с радиоактивными материалами всегда проходите дозиметрический контроль.",
    "При работе с криогенными жидкостями (например, жидким азотом) используйте защитные очки и перчатки, чтобы избежать обморожения.",
    "Обеспечьте хорошую вентиляцию при работе с криогенными жидкостями, так как они могут вытеснять кислород из воздуха.",
    "Никогда не используйте бытовые термосы для хранения криогенных жидкостей. Используйте только специальные сосуды Дьюара.",
    "При работе с кислотами и щелочами всегда надевайте химически стойкие перчатки, очки и фартук.",
    "При разбавлении кислоты всегда медленно добавляйте кислоту в воду, а не наоборот, чтобы избежать бурной реакции и разбрызгивания.",
    "Знайте, где находится ближайший аварийный душ и фонтан для промывки глаз, и как ими пользоваться.",
    "Если вы пролили химикат, немедленно сообщите об этом и действуйте согласно плану ликвидации разливов.",
    "Не храните несовместимые химические вещества рядом друг с другом (например, кислоты и основания, окислители и горючие материалы).",
    "Маркируйте все контейнеры с химикатами, даже если это временный рабочий раствор. Указывайте название, концентрацию и дату.",
    "При работе с легковоспламеняющимися жидкостями используйте заземленное оборудование, чтобы предотвратить образование статического электричества.",
    "Никогда не используйте открытый огонь рядом с местами хранения или использования горючих жидкостей.",
    "При работе в пыльной среде используйте респиратор соответствующего класса защиты.",
    "Регулярная уборка пыли важна, так как скопления органической или металлической пыли могут быть взрывоопасны.",
    "Перед тем, как войти в помещение, где может быть пыль, убедитесь, что вентиляция работает эффективно.",
    "При работе с животными в лаборатории или на ферме всегда мойте руки после контакта и используйте перчатки.",
    "Будьте осведомлены о рисках зоонозных заболеваний (передающихся от животных человеку) и соблюдайте меры профилактики.",
    "Никогда не подходите к незнакомым или диким животным. Они могут быть переносчиками болезней или повести себя агрессивно.",
    "Если вас укусило или оцарапало животное, немедленно промойте рану и обратитесь к врачу.",
    "При оказании первой помощи пострадавшему сначала убедитесь в собственной безопасности. Не подвергайте себя риску.",
    "Не перемещайте пострадавшего с подозрением на травму позвоночника, если нет непосредственной угрозы его жизни.",
    "При сильном кровотечении наложите давящую повязку прямо на рану и не снимайте ее до приезда медиков.",
    "Пройдите курс оказания первой помощи. Эти знания могут спасти чью-то жизнь в критической ситуации.",
    "При использовании автоматического наружного дефибриллятора (АНД) следуйте голосовым инструкциям прибора.",
    "В случае возникновения пожара не паникуйте. Активируйте пожарную сигнализацию и немедленно начинайте эвакуацию.",
    "Перед тем как открыть дверь в задымленном помещении, потрогайте ее тыльной сторой ладони. Если она горячая, не открывайте.",
    "При движении в задымленном помещении держитесь как можно ниже к полу, где воздух чище и прохладнее.",
    "Никогда не возвращайтесь в горящее здание за вещами.",
    "Используйте огнетушитель только если вы уверены в своих силах и знаете, что делать. Ваша главная задача — эвакуироваться.",
    "Никогда не вставляйте посторонние предметы в электрические розетки.",
    "Если электроприбор задымился или заискрил, немедленно отключите его от сети, если это безопасно, и обесточьте помещение.",
    "Не используйте удлинители на постоянной основе для мощных приборов. Они предназначены для временного использования.",
    "Если вы видите оборванный провод линии электропередач, не приближайтесь к нему ближе чем на 10 метров и немедленно сообщите в экстренные службы.",
    "Перед работой на высоте проверьте погодные условия. Не работайте при сильном ветре или грозе.",
    "При использовании приставной лестницы устанавливайте ее под углом примерно 75 градусов (правило 4 к 1: на 4 единицы высоты 1 единица от стены).",
    "Убедитесь, что приставная лестница выступает над точкой опоры как минимум на 1 метр для безопасного подъема и спуска.",
    "Пристегивайте страховочную привязь к надежной анкерной точке, способной выдержать необходимую нагрузку.",
    "Никогда не бросайте инструменты или материалы с высоты. Используйте специальные сумки или подъемные механизмы.",
    "Ограждайте зону под местом проведения работ на высоте, чтобы защитить людей внизу от падающих предметов.",
    "Соблюдайте питьевой режим в течение дня, даже если не чувствуете жажды. Обезвоживание снижает концентрацию.",
    "Признаки теплового удара: высокая температура тела, отсутствие пота, спутанность сознания. Немедленно вызывайте скорую помощь.",
    "При работе на холоде делайте регулярные перерывы в теплом помещении, чтобы согреться.",
    "Первые признаки обморожения — покалывание и онемение. Немедленно ищите теплое укрытие.",
    "Будьте осторожны при ходьбе по мокрым листьям осенью. Они могут быть такими же скользкими, как лед.",
    "При купании в открытых водоемах заходите в воду постепенно, чтобы избежать шока от холодной воды.",
    "Не ныряйте в незнакомых местах. Под водой могут быть камни, коряги или недостаточная глубина.",
    "Если вас унесло течением, не паникуйте и не гребите против него. Плывите по диагонали к берегу.",
    "Во время грозы на открытой местности избегайте высоких деревьев и ищите укрытие в низине.",
    "Не прикасайтесь к металлическим предметам на улице во время грозы.",
    "При работе в саду будьте осторожны с ядовитыми растениями. Носите перчатки и длинные рукава.",
    "После прогулки в лесу или парке всегда осматривайте себя на наличие клещей. Их укус может быть опасен.",
    "Не ешьте незнакомые ягоды или грибы. Они могут быть ядовитыми.",
    "При встрече со змеей не делайте резких движений и медленно отступайте назад.",
    "Храните номера экстренных служб в телефоне и на видном месте дома.",
    "Обсудите с семьей план действий на случай различных чрезвычайных ситуаций (пожар, наводнение, ураган).",
    "Соберите 'тревожный чемоданчик' с запасом воды, еды, лекарств, фонариком и документами.",
    "При получении сигнала тревоги (сирены) включите радио или телевизор, чтобы получить официальную информацию.",
    "Не распространяйте слухи и непроверенную информацию во время ЧС. Доверяйте только официальным источникам.",
    "Если вы застряли в лифте, не пытайтесь выбраться самостоятельно. Нажмите кнопку вызова диспетчера и ждите помощи.",
    "При использовании эскалатора держитесь за поручень и не наступайте на желтые линии по краям ступеней.",
    "Будьте вежливы и внимательны к другим. Конфликты на рабочем месте могут создавать небезопасную психологическую обстановку.",
    "Сообщайте о случаях травли или домогательств. Каждый имеет право на безопасную и уважительную рабочую среду.",
    "Если ваша работа связана с эмоциональным напряжением, найдите здоровые способы справляться со стрессом: спорт, хобби, общение.",
    "Не стесняйтесь обращаться за психологической помощью, если чувствуете, что не справляетесь самостоятельно.",
    "Защищайте свою личную информацию в интернете. Не публикуйте домашний адрес, номер телефона или финансовые данные.",
    "Остерегайтесь мошенников, которые звонят или пишут от имени банков или госорганов. Никогда не сообщайте им пароли или коды из СМС.",
    "Перед тем, как что-то выбросить, убедитесь, что на документах или устройствах нет конфиденциальной информации. Используйте шредер.",
    "Если вы стали свидетелем несчастного случая, не оставайтесь в стороне. Вызовите помощь и, если умеете, окажите первую помощь.",
    "Правильно утилизируйте отходы, особенно опасные, такие как батарейки, лампы или химикаты.",
    "Экономьте ресурсы — воду и электроэнергию. Это не только экологично, но и снижает нагрузку на системы, предотвращая аварии.",
    "Принимайте активное участие в улучшении безопасности на вашем рабочем месте. Ваши предложения могут предотвратить несчастный случай.",
    "Безопасность — это не разовая акция, а постоянный процесс. Будьте бдительны каждый день.",
    "Помните, что за каждым правилом безопасности стоит чей-то опыт, часто печальный. Соблюдая их, вы защищаете себя и других."
];


// FIX: Made the `children` prop optional by adding a `?` to its type definition.
// This resolves a TypeScript error where the compiler incorrectly reports that
// the `children` prop is missing, even though it is provided in all usages.
const ReportSection = ({ title, children, className = '' }: { title: string, children?: React.ReactNode, className?: string }) => (
    <section className={`report-section mb-6 break-inside-avoid ${className}`}>
        <h3 className="font-bold text-gray-800 border-b-2 border-gray-300 pb-2 mb-3" style={{ fontSize: '15px' }}>{title}</h3>
        <div className="space-y-2">{children}</div>
    </section>
);

const MetricItem = ({ label, value }: { label: string, value: string | number }) => (
    <div className="flex justify-between items-baseline text-sm">
        <p className="text-gray-600 truncate pr-2">{label}:</p>
        <p className="text-gray-900 font-semibold text-right pl-2">{String(value) || '__'}</p>
    </div>
);

const SbsSummaryCard = ({ title, data }: { title: string, data: any[] }) => {
    const percentage = parseFloat(data.find(d => d.label === 'Выполнение')?.value) || 0;
    const isSuccess = percentage >= 100;
    const isWarning = percentage > 0 && percentage < 100;

    return (
        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 break-inside-avoid">
            <h4 className="font-semibold text-gray-800 mb-3" style={{ fontSize: '13px' }}>{title}</h4>
            <div className="space-y-2 text-sm">
                {data.map((item, index) => (
                    <div key={index} className="flex justify-between items-center">
                        <span className="text-gray-600">{item.label}:</span>
                        <span className={`font-bold ${item.label === 'Выполнение' ? (isSuccess ? 'text-green-600' : isWarning ? 'text-yellow-600' : 'text-gray-800') : 'text-gray-800'}`}>
                            {item.value}
                        </span>
                    </div>
                ))}
            </div>
            {data.some(d => d.label === 'Выполнение') && (
                 <div className="mt-3">
                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                        <div 
                            className={`h-2.5 rounded-full ${isSuccess ? 'bg-green-500' : isWarning ? 'bg-yellow-500' : 'bg-gray-400'}`} 
                            style={{ width: `${Math.min(percentage, 100)}%` }}>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const ReportPreview = ({ formData }: { formData: any }) => {
    return (
        <div id="report-content" className="font-sans text-gray-900 bg-white p-6 rounded-lg" style={{ fontSize: '12px' }}>
            {/* === PAGE 1 === */}
            <div className="pdf-page">
                <header className="text-center mb-8">
                    <h2 className="font-extrabold text-black" style={{ fontSize: '24px' }}>Беседа по эффективности</h2>
                    <p className="text-gray-500 text-lg">Сменный отчет</p>
                    <p className="text-gray-500 text-md mt-1">{new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                </header>
                
                <p className="mb-6 text-gray-500 italic text-center">
                    Здравствуйте, коллеги. Начнем нашу беседу по эффективности с контакта по безопасности. У кого есть чем поделиться?
                </p>

                <ReportSection title="Контакт по безопасности и поручения">
                    <p className="text-gray-800 whitespace-pre-wrap leading-relaxed p-4 bg-gray-100 rounded-md border border-gray-200 text-sm">
                        {formData.safetyContact || '__'}
                    </p>
                    <div className="mt-4 columns-2 gap-x-6">
                        <div className="break-inside-avoid">
                            <h4 className="font-semibold text-gray-800 mb-2" style={{ fontSize: '13px' }}>Выполнено:</h4>
                            <p className="text-green-700 font-medium">{formData.prevShiftCompleted || '__'}</p>
                        </div>
                        <div className="break-inside-avoid">
                            <h4 className="font-semibold text-gray-800 mb-2" style={{ fontSize: '13px' }}>Не выполнено:</h4>
                            <p className="text-yellow-700 font-medium">{formData.prevShiftNotCompleted || '__'}</p>
                        </div>
                    </div>
                </ReportSection>

                <div className="grid md:grid-cols-2 gap-x-8 gap-y-4">
                    <ReportSection title="Безопасность">
                        <MetricItem label="Травматизм и несчастные случаи" value={formData.injuries} />
                        <MetricItem label="Аварии" value={formData.accidents} />
                        <MetricItem label="Отработали" value={formData.workSafety} />
                        <MetricItem label="LTIF" value={formData.ltif} />
                        <MetricItem label="Индекс аварийности" value={formData.accidentIndex} />
                    </ReportSection>

                    <ReportSection title="Персонал">
                        <MetricItem label="На смене / Всего" value={`${formData.shiftOn} / ${formData.shiftTotal}`} />
                        <MetricItem label="В другой смене" value={formData.otherShift} />
                        <MetricItem label="В отпуске" value={formData.vacation} />
                        <MetricItem label="Из другой смены" value={formData.fromOtherShift} />
                        <MetricItem label="На больничном" value={formData.sickLeave} />
                        <MetricItem label="Индекс компетенции" value={`${formData.competenceIndex}%`} />
                        <MetricItem label="Риски по компетенциям" value={formData.competenceRisks} />
                    </ReportSection>
                </div>
                
                <p className="my-6 text-gray-500 italic text-center">
                    Передаем слово старшему менеджеру.
                </p>
            </div>

            {/* === PAGE 2 === */}
            <div className="pdf-page print-page-break">
                <div className="grid md:grid-cols-2 gap-x-8 gap-y-4">
                    <ReportSection title="Технические показатели">
                        <MetricItem label="Нарушения НТР (сутки)" value={formData.ntrViolations} />
                        <MetricItem label="Нарушения НАК (сутки)" value={formData.nakViolations} />
                        <MetricItem label="Повторяющиеся события" value={formData.recurringEvents} />
                        <MetricItem label="Срабатывания сигнализации АСУТП" value={`${formData.asutpAlarms} шт.`} />
                        <MetricItem label="Регуляторы АСУТП в авто (сутки / месяц)" value={`${formData.asutpAutoModeDaily} / ${formData.asutpAutoModeMonthly}`} />
                        <MetricItem label="Срабатывания ПАЗ" value={formData.pazActivations} />
                        <MetricItem label="Отключение блокировок" value={formData.blockerOverrides} />
                    </ReportSection>

                    <ReportSection title="Производственные показатели">
                        <MetricItem label="Отклонение от расходных норм" value={formData.consumptionDeviation} />
                        <div className="space-y-1">
                            <MetricItem label="АО по Т50 (факт / план)" value={`${formData.aoT50actual || '__'} / ${formData.aoT50plan || '__'}`} />
                            {formData.aoT50change && <p className="text-xs text-right text-gray-500 italic pr-1">{formData.aoT50change}</p>}
                        </div>
                        <div className="space-y-1">
                            <MetricItem label="АО по Т100 (факт / план)" value={`${formData.aoT100actual || '__'} / ${formData.aoT100plan || '__'}`} />
                            {formData.aoT100change && <p className="text-xs text-right text-gray-500 italic pr-1">{formData.aoT100change}</p>}
                        </div>
                        <MetricItem label="Расход ВДСК" value={formData.vdskConsumption} />
                        
                        <div className="columns-2 gap-x-6 mt-4 pt-4 border-t border-gray-200">
                             <div className="break-inside-avoid mb-4">
                                <h4 className="font-semibold text-gray-700 mb-2" style={{ fontSize: '13px' }}>Анализы 1/2 тл</h4>
                                <div className="space-y-1">
                                    <MetricItem label="К.В." value={formData.analysis12_kv} />
                                    <MetricItem label="Потери" value={formData.analysis12_loss} />
                                    <MetricItem label="Насыпная плотность" value={formData.analysis12_bulk_density} />
                                    <MetricItem label="Цвет" value={formData.analysis12_color} />
                                    <MetricItem label="Агломерация" value={formData.analysis12_agglomeration} />
                                </div>
                            </div>
                            <div className="break-inside-avoid">
                                <h4 className="font-semibold text-gray-700 mb-2" style={{ fontSize: '13px' }}>Анализы 3 тл</h4>
                                <div className="space-y-1">
                                    <MetricItem label="К.В." value={formData.analysis3_kv} />
                                    <MetricItem label="Потери" value={formData.analysis3_loss} />
                                    <MetricItem label="Насыпная плотность" value={formData.analysis3_bulk_density} />
                                    <MetricItem label="Цвет" value={formData.analysis3_color} />
                                    <MetricItem label="Агломерация" value={formData.analysis3_agglomeration} />
                                </div>
                            </div>
                        </div>
                        
                        <MetricItem label="Неидентифицированные дебалансы" value={formData.unidentifiedImbalances} />
                        <MetricItem label="Время в зеленой зоне" value={`${formData.greenZoneTime}%`} />
                        <MetricItem label="Эффективность СУУТП" value={`${formData.suutpEfficiency}%`} />
                        <MetricItem label="Выработка 1/2 тл" value={formData.dailyProduction12} />
                        <MetricItem label="Выработка 3 тл" value={formData.dailyProduction3} />
                    </ReportSection>
                </div>
            </div>
            
            {/* === PAGE 3 === */}
            <div className="pdf-page print-page-break">
                <p className="my-6 text-gray-500 italic text-center">
                    ВИП, ВИТ задают вопросы. Читаю ШПАРГАЛКУ.
                </p>

                <ReportSection title="Динамика выполнения плана производства СБС">
                    <div className="grid md:grid-cols-2 gap-4">
                        <SbsSummaryCard title="Упаковано за сутки" data={[
                            { label: 'План, т', value: formData.packedDailyPlan },
                            { label: 'Факт, т', value: formData.packedDailyActual },
                            { label: 'Выполнение', value: `${formData.packedDailyPercentage}%` },
                        ]} />
                        <SbsSummaryCard title="Паспортизовано за сутки" data={[
                            { label: 'План, т', value: formData.certifiedDailyPlan },
                            { label: 'Факт, т', value: formData.certifiedDailyActual },
                            { label: 'Выполнение', value: `${formData.certifiedDailyPercentage}%` },
                        ]} />
                        <SbsSummaryCard title="Упаковано с начала месяца" data={[
                            { label: 'План нараст., т', value: formData.packedMonthlyPlanCumulative },
                            { label: 'Факт нараст., т', value: formData.packedMonthlyActualCumulative },
                            { label: 'План на месяц, т', value: formData.packedMonthlyPlanTotal },
                            { label: 'Выполнение', value: `${formData.packedMonthlyPercentage}%` },
                        ]} />
                        <SbsSummaryCard title="Паспортизировано с начала месяца" data={[
                            { label: 'План нараст., т', value: formData.certifiedMonthlyPlanCumulative },
                            { label: 'Факт нараст., т', value: formData.certifiedMonthlyActualCumulative },
                            { label: 'План на месяц, т', value: formData.certifiedMonthlyPlanTotal },
                            { label: 'Выполнение', value: `${formData.certifiedMonthlyPercentage}%` },
                        ]} />
                    </div>
                </ReportSection>
                
                <ReportSection title="Дополнительная информация">
                    <MetricItem label="Замечания от лаборатории" value={formData.labComments} />
                    <MetricItem label="Причины простоев" value={formData.downtimeReasons} />
                    <MetricItem label="Риски" value={formData.risks} />
                </ReportSection>
                
                <div className="mt-8 pt-4 border-t border-gray-300 text-gray-500 space-y-2 italic text-center text-sm">
                    <p>Слово ИПРО о наличии сырья и ограничении.</p>
                    <p>ВИП ВИТ задают вопросы.</p>
                    <p>Слово сменным инженерам.</p>
                    <p>НС- Подводит итоги</p>
                </div>
            </div>
        </div>
    );
};


const App = () => {
    const [formData, setFormData] = useState({
        safetyContact: '',
        prevShiftCompleted: '',
        prevShiftNotCompleted: '',
        injuries: 'не зарегистрировано',
        accidents: 'не зарегистрировано',
        workSafety: 'безопасно',
        ltif: 'нулю',
        accidentIndex: 'нулю',
        shiftOn: '',
        shiftTotal: '',
        otherShift: '',
        vacation: '',
        fromOtherShift: '',
        sickLeave: '',
        competenceIndex: '',
        competenceRisks: 'Отсутствуют',
        ntrViolations: 'не зарегистрировано',
        nakViolations: 'не зарегистрировано',
        recurringEvents: 'не обнаружено',
        asutpAlarms: '',
        asutpAutoModeDaily: '',
        asutpAutoModeMonthly: '',
        pazActivations: 'не зарегистрировано',
        blockerOverrides: 'не производилось',
        // SBS Production Summary
        packedDailyPlan: '',
        packedDailyActual: '',
        packedDailyPercentage: '',
        certifiedDailyPlan: '',
        certifiedDailyActual: '',
        certifiedDailyPercentage: '',
        certifiedMonthlyPlanCumulative: '',
        certifiedMonthlyActualCumulative: '',
        certifiedMonthlyPlanTotal: '',
        certifiedMonthlyPercentage: '',
        packedMonthlyPlanCumulative: '',
        packedMonthlyActualCumulative: '',
        packedMonthlyPlanTotal: '',
        packedMonthlyPercentage: '',
        // Production Indicators
        consumptionDeviation: 'не зарегистрировано',
        aoT50actual: '',
        aoT50plan: '',
        aoT50change: '',
        aoT100actual: '',
        aoT100plan: '',
        aoT100change: '',
        vdskConsumption: 'в норме',
        analysis12_kv: '',
        analysis12_loss: '',
        analysis12_bulk_density: '',
        analysis12_color: '',
        analysis12_agglomeration: '',
        analysis3_kv: '',
        analysis3_loss: '',
        analysis3_bulk_density: '',
        analysis3_color: '',
        analysis3_agglomeration: '',
        unidentifiedImbalances: 'не обнаружено',
        greenZoneTime: '',
        ekonsExceptions: '',
        suutpEfficiency: '',
        dailyProduction12: '',
        dailyProduction3: '',
        labComments: 'не было',
        downtimeReasons: '',
        risks: '',
    });

    const [selectedApi, setSelectedApi] = useState<ApiProvider>('local');
    const [apiKeys, setApiKeys] = useState<Record<ApiProvider, string>>({ local: '', gemini: '' });
    const [copyButtonText, setCopyButtonText] = useState('Скопировать отчет');
    const [isGenerating, setIsGenerating] = useState(false);
    const [errors, setErrors] = useState<Partial<Record<keyof typeof formData, string>>>({});

    useEffect(() => {
        try {
            const savedKeys = localStorage.getItem('apiKeys');
            if (savedKeys) {
                setApiKeys(JSON.parse(savedKeys));
            }
        } catch (error) {
            console.error("Failed to load API keys from localStorage:", error);
        }
    }, []);

    useEffect(() => {
        const calculatePercentage = (actualStr: string, planStr: string): string => {
            const actual = parseFloat(actualStr);
            const plan = parseFloat(planStr);
            if (isNaN(actual) || isNaN(plan) || plan === 0) {
                return '';
            }
            return Math.round((actual / plan) * 100).toString();
        };

        setFormData(prev => ({
            ...prev,
            packedDailyPercentage: calculatePercentage(prev.packedDailyActual, prev.packedDailyPlan),
            certifiedDailyPercentage: calculatePercentage(prev.certifiedDailyActual, prev.certifiedDailyPlan),
            certifiedMonthlyPercentage: calculatePercentage(prev.certifiedMonthlyActualCumulative, prev.certifiedMonthlyPlanCumulative),
            packedMonthlyPercentage: calculatePercentage(prev.packedMonthlyActualCumulative, prev.packedMonthlyPlanCumulative),
        }));
    }, [
        formData.packedDailyActual, formData.packedDailyPlan,
        formData.certifiedDailyActual, formData.certifiedDailyPlan,
        formData.certifiedMonthlyActualCumulative, formData.certifiedMonthlyPlanCumulative,
        formData.packedMonthlyActualCumulative, formData.packedMonthlyPlanCumulative
    ]);


    const validate = (): boolean => {
        const newErrors: Partial<Record<keyof typeof formData, string>> = {};

        // Required text fields
        (['safetyContact', 'prevShiftCompleted', 'prevShiftNotCompleted', 'analysis12_color', 'analysis12_agglomeration', 'analysis3_color', 'analysis3_agglomeration'] as const).forEach(field => {
            if (!formData[field].trim()) {
                newErrors[field] = 'Это поле обязательно для заполнения.';
            }
        });

        // Required integer fields
        const integerFields = ['shiftOn', 'shiftTotal', 'otherShift', 'vacation', 'fromOtherShift', 'sickLeave', 'asutpAlarms'] as const;
        integerFields.forEach(field => {
            if (!formData[field].trim()) {
                newErrors[field] = 'Это поле обязательно для заполнения.';
            } else if (!/^\d+$/.test(formData[field])) {
                newErrors[field] = 'Поле должно содержать только целые положительные числа.';
            }
        });

        // Required numeric (can be decimal) fields
        const numericFields = [
            'aoT50actual', 'aoT50plan', 'aoT100actual', 'aoT100plan', 'dailyProduction12', 'dailyProduction3',
            'analysis12_kv', 'analysis12_loss', 'analysis12_bulk_density',
            'analysis3_kv', 'analysis3_loss', 'analysis3_bulk_density',
            'packedDailyPlan', 'packedDailyActual',
            'certifiedDailyPlan', 'certifiedDailyActual',
            'certifiedMonthlyPlanCumulative', 'certifiedMonthlyActualCumulative', 'certifiedMonthlyPlanTotal',
            'packedMonthlyPlanCumulative', 'packedMonthlyActualCumulative', 'packedMonthlyPlanTotal'
        ] as const;
        numericFields.forEach(field => {
            if (!formData[field].trim()) {
                newErrors[field] = 'Это поле обязательно для заполнения.';
            } else if (!/^\d*\.?\d+$/.test(formData[field])) {
                newErrors[field] = 'Поле должно быть положительным числом.';
            }
        });

        // Required percentage fields
        const percentageFields = ['competenceIndex', 'greenZoneTime', 'suutpEfficiency', 'asutpAutoModeDaily', 'asutpAutoModeMonthly'] as const;
        percentageFields.forEach(field => {
            const valueStr = formData[field].replace('%', '').trim();
            if (!valueStr) {
                newErrors[field] = 'Это поле обязательно для заполнения.';
            } else {
                const value = parseFloat(valueStr);
                if (isNaN(value) || value < 0 || value > 100) {
                    newErrors[field] = 'Значение должно быть числом от 0 до 100.';
                }
            }
        });

        // Custom logic: check if shiftOn <= shiftTotal
        const shiftOn = parseInt(formData.shiftOn, 10);
        const shiftTotal = parseInt(formData.shiftTotal, 10);
        if (!isNaN(shiftOn) && !isNaN(shiftTotal) && shiftOn > shiftTotal) {
            newErrors.shiftTotal = 'Всего в смене не может быть меньше, чем на смене.';
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleApiKeyChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { value } = e.target;
        const newKeys = { ...apiKeys, [selectedApi]: value };
        setApiKeys(newKeys);
        try {
            localStorage.setItem('apiKeys', JSON.stringify(newKeys));
        } catch (error) {
            console.error("Failed to save API keys to localStorage:", error);
        }
    };

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
        if (errors[name as keyof typeof formData]) {
            setErrors(prev => {
                const newErrors = { ...prev };
                delete newErrors[name as keyof typeof formData];
                if (name === 'shiftOn' || name === 'shiftTotal') {
                    delete newErrors.shiftOn;
                    delete newErrors.shiftTotal;
                }
                return newErrors;
            });
        }
    };
    
    const handleRadioChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };
    
    const prompt = "Сгенерируй 'контакт по безопасности' для производственного предприятия. Текст должен состоять из 5 предложений. В тексте опиши потенциально опасную ситуацию и дай четкие инструкции, как ее избежать.";

    const generateWithGemini = async (apiKey: string): Promise<string> => {
        const ai = new GoogleGenAI({ apiKey });
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
        });
        return response.text;
    };

    const handleGenerateClick = async () => {
        if (selectedApi === 'local') {
            setIsGenerating(true);
            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * PREDEFINED_SAFETY_CONTACTS.length);
                const randomContact = PREDEFINED_SAFETY_CONTACTS[randomIndex];
                setFormData(prev => ({ ...prev, safetyContact: randomContact }));
                setIsGenerating(false);
            }, 300);
            return;
        }

        const apiKey = apiKeys[selectedApi];
        if (!apiKey) {
            alert(`Пожалуйста, введите API ключ для ${API_CONFIG[selectedApi].name}.`);
            return;
        }
        
        setIsGenerating(true);
        try {
            let generatedText = '';
            if (selectedApi === 'gemini') {
                generatedText = await generateWithGemini(apiKey);
            }
            setFormData(prev => ({ ...prev, safetyContact: generatedText.trim() }));
        } catch (error) {
            console.error(`Error generating with ${selectedApi}:`, error);
            alert(`Не удалось сгенерировать контакт. Пожалуйста, проверьте ваш API ключ и попробуйте еще раз. \nОшибка: ${(error as Error).message}`);
        } finally {
            setIsGenerating(false);
        }
    };

    const generatePlainTextReport = (data: typeof formData) => {
        const today = new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        return `Беседа по эффективности.
Дата: ${today}
Здравствуйте, коллеги. Начнем нашу беседу по эффективности с контакта по безопасности. У кого есть чем поделиться?
Контакт по безопасности: ${data.safetyContact || '__'}
Поручения за предыдущую смену:
Выполнено: ${data.prevShiftCompleted || '__'}
Не выполнено: ${data.prevShiftNotCompleted || '__'}

За прошедшие сутки травматизма и несчастных случаев: ${data.injuries}.
аварий: ${data.accidents}.
отработали: ${data.workSafety}.
Ltif равен: ${data.ltif}.
индекс аварийности равен: ${data.accidentIndex}.
На смене ${data.shiftOn || '__'} из ${data.shiftTotal || '__'}.
${data.otherShift || '__'} человек в другой смене.
${data.vacation || '__'} в отпуске.
${data.fromOtherShift || '__'} из другой смены.
${data.sickLeave || '__'} больничный лист.
Индекс компетенции составляет ${data.competenceIndex || '__'}% с учетом вакансий.
Риски на проведение операций на основании индекса компетентности? ${data.competenceRisks || 'Отсутствуют'}.
Передаем слово старшему менеджеру.

Количество нарушений НТР за сутки: ${data.ntrViolations || '__'}
Нарушения НАК за сутки: ${data.nakViolations || '__'}
Повторящихся событий, критичных нарушений, наличие отклонений: ${data.recurringEvents || 'не обнаружено'}.
Количество срабатываний сигнализации АСУТП ${data.asutpAlarms || '__'} шт.
Работа регуляторов АСУТП в автоматическом режиме ${data.asutpAutoModeDaily || '__'} за сутки. ${data.asutpAutoModeMonthly || '__'} за месяц при норме до 95.
Срабатывания ПАЗ: ${data.pazActivations}.
Отключение блокировок: ${data.blockerOverrides || 'не производилось'}.
Часы максимум за сутки в норме.

ВИП, ВИТ задают вопросы.
Отклонение от расходных норм: ${data.consumptionDeviation}.

АО по Т50 получили ${data.aoT50actual || '__'} при задании ${data.aoT50plan || '__'}. ${data.aoT50change || ''}

АО по Т100 получили ${data.aoT100actual || '__'} при задании ${data.aoT100plan || '__'}. ${data.aoT100change || ''}

Расход ВДСК ${data.vdskConsumption}.
Анализы 1/2 тл: К.В.: ${data.analysis12_kv || '__'}; Потери: ${data.analysis12_loss || '__'}; Насыпная плотность: ${data.analysis12_bulk_density || '__'}; Цвет: ${data.analysis12_color || '__'}; Агломерация: ${data.analysis12_agglomeration || '__'}.
Анализы 3 тл: К.В.: ${data.analysis3_kv || '__'}; Потери: ${data.analysis3_loss || '__'}; Насыпная плотность: ${data.analysis3_bulk_density || '__'}; Цвет: ${data.analysis3_color || '__'}; Агломерация: ${data.analysis3_agglomeration || '__'}.

Читаю ШПАРГАЛКУ.

Наличие не идентифицированных дебалансов и потерь ${data.unidentifiedImbalances}.

Время нахождения в зеленой зоне ${data.greenZoneTime || '__'}%
Показатели ЭкОНС в зеленой зоне. Кроме: ${data.ekonsExceptions || '__'}
Полная эффективность СУУТП ${data.suutpEfficiency || '__'}%
Выработка 1/2 тл составила: ${data.dailyProduction12 || '__'}
Выработка 3 тл составила: ${data.dailyProduction3 || '__'}

Динамика выполнения плана производства СБС:
- Упаковано за сутки: План ${data.packedDailyPlan || '__'} т, Факт ${data.packedDailyActual || '__'} т. Выполнение плана: ${data.packedDailyPercentage || '__'}%.
- Паспортизовано за сутки: План ${data.certifiedDailyPlan || '__'} т, Факт ${data.certifiedDailyActual || '__'} т. Выполнение плана: ${data.certifiedDailyPercentage || '__'}%.
- Паспортизировано с начала месяца: План нараст. ${data.certifiedMonthlyPlanCumulative || '__'} т, Факт нараст. ${data.certifiedMonthlyActualCumulative || '__'} т. (План на месяц: ${data.certifiedMonthlyPlanTotal || '__'} т). Выполнение плана: ${data.certifiedMonthlyPercentage || '__'}%.
- Упаковано с начала месяца: План нараст. ${data.packedMonthlyPlanCumulative || '__'} т, Факт нараст. ${data.packedMonthlyActualCumulative || '__'} т. (План на месяц: ${data.packedMonthlyPlanTotal || '__'} т). Выполнение плана: ${data.packedMonthlyPercentage || '__'}%.

Замечаний от лаборатории по готовой: ${data.labComments || 'не было'}.
Были простои по причине: ${data.downtimeReasons || '__'}
Есть риски: ${data.risks || '__'}
Слово ИПРО о наличии сырья и ограничении.
ВИП ВИТ задают вопросы.
Слово сменным инженерам.
НС- Подводит итоги`;
    };

    const copyToClipboard = () => {
        const reportText = generatePlainTextReport(formData);
        navigator.clipboard.writeText(reportText).then(() => {
            setCopyButtonText('Скопировано!');
            setTimeout(() => setCopyButtonText('Скопировать отчет'), 2000);
        });
    };
    
    const handleSaveAsTxt = () => {
        const reportText = generatePlainTextReport(formData);
        const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'otchet.txt';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    };

    const renderRadioGroup = (name: keyof typeof formData, label: string, options: { value: string; label: string }[]) => (
        <div className="mb-4">
            <label className="block mb-2 text-sm font-medium text-gray-300">{label}</label>
            <div className="flex flex-wrap gap-x-4 gap-y-2">
                {options.map(option => (
                    <label key={option.value} className="flex items-center space-x-2 text-sm cursor-pointer">
                        <input
                            type="radio"
                            name={name}
                            value={option.value}
                            checked={formData[name] === option.value}
                            onChange={handleRadioChange}
                            className="form-radio h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-600"
                        />
                        <span>{option.label}</span>
                    </label>
                ))}
            </div>
        </div>
    );
    
    const renderInputField = (name: keyof typeof formData, label: string, placeholder = '', type = 'text', readOnly = false) => {
        const hasError = !!errors[name];
        return (
            <div className="mb-4">
                <label htmlFor={name} className="block mb-2 text-sm font-medium text-gray-300">{label}</label>
                <input
                    type={type}
                    id={name}
                    name={name}
                    value={formData[name]}
                    onChange={handleInputChange}
                    placeholder={placeholder}
                    readOnly={readOnly}
                    className={`w-full bg-gray-700 border rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500 transition ${hasError ? 'border-red-500 ring-1 ring-red-500' : 'border-gray-600'} ${readOnly ? 'bg-gray-600 cursor-not-allowed' : ''}`}
                    aria-invalid={hasError}
                    aria-describedby={hasError ? `${String(name)}-error` : undefined}
                />
                {hasError && <p id={`${String(name)}-error`} className="mt-1 text-sm text-red-400">{errors[name]}</p>}
            </div>
        );
    };
    
    const renderTextareaField = (name: keyof typeof formData, label: string, placeholder = '', rows = 3) => {
        const hasError = !!errors[name];
        return (
             <div className="mb-4">
                <label htmlFor={name} className="block mb-2 text-sm font-medium text-gray-300">{label}</label>
                <textarea
                    id={name}
                    name={name}
                    rows={rows}
                    value={formData[name]}
                    onChange={handleInputChange}
                    placeholder={placeholder}
                    className={`w-full bg-gray-700 border rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500 transition ${hasError ? 'border-red-500 ring-1 ring-red-500' : 'border-gray-600'}`}
                    aria-invalid={hasError}
                    aria-describedby={hasError ? `${String(name)}-error` : undefined}
                />
                {hasError && <p id={`${String(name)}-error`} className="mt-1 text-sm text-red-400">{errors[name]}</p>}
            </div>
        );
    };

    const isApiKeyMissing = selectedApi !== 'local' && !apiKeys[selectedApi];

    return (
        <div className="min-h-screen bg-gray-900 text-white p-4 sm:p-6 lg:p-8">
            <header className="text-center mb-10 no-print">
                <h1 className="text-4xl font-bold text-white">
                    Генератор отчета
                    <span className="text-lg align-baseline font-normal text-gray-400 ml-2">версия 1.0</span>
                </h1>
                <p className="text-lg text-gray-400 mt-2">"Беседа по эффективности"</p>
            </header>
            <main className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
                {/* Form Section */}
                <div className="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 no-print">
                    <div className="mb-6 p-4 border border-blue-900/50 bg-blue-900/20 rounded-lg">
                        <label className="block mb-3 text-sm font-medium text-gray-200">Выберите источник генерации</label>
                        <div className="flex bg-gray-700 rounded-lg p-1">
                            {(Object.keys(API_CONFIG) as ApiProvider[]).map(api => (
                                <button
                                    key={api}
                                    onClick={() => setSelectedApi(api)}
                                    className={`w-full py-2 text-sm font-semibold rounded-md transition-colors duration-200 ${selectedApi === api ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-600'}`}
                                >
                                    {API_CONFIG[api].name}
                                </button>
                            ))}
                        </div>
                        {API_CONFIG[selectedApi].keyLink && (
                            <div className="mt-4">
                                <div className="flex justify-between items-center mb-2">
                                    <label htmlFor="apiKey" className="text-sm font-medium text-gray-300">
                                        {API_CONFIG[selectedApi].name} API Ключ
                                    </label>
                                    <a href={API_CONFIG[selectedApi].keyLink} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-400 hover:underline">
                                        Получить ключ
                                    </a>
                                </div>
                                <input
                                    id="apiKey"
                                    type="password"
                                    value={apiKeys[selectedApi]}
                                    onChange={handleApiKeyChange}
                                    placeholder={API_CONFIG[selectedApi].placeholder}
                                    className="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                        )}
                    </div>

                    <form>
                         <fieldset className="mb-6">
                            <legend className="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2 w-full">Общая информация</legend>
                            <div className="relative">
                                {renderTextareaField('safetyContact', 'Контакт по безопасности', 'Введите контакт по безопасности вручную или сгенерируйте...', 5)}
                                <button
                                    type="button"
                                    onClick={handleGenerateClick}
                                    disabled={isGenerating || isApiKeyMissing}
                                    className="absolute bottom-6 right-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 flex items-center"
                                    title={isApiKeyMissing ? `Введите API ключ для ${API_CONFIG[selectedApi].name}` : "Сгенерировать"}
                                >
                                    {isGenerating ? (
                                        <>
                                            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Генерация...
                                        </>
                                    ) : (
                                        '✨ Сгенерировать'
                                    )}
                                </button>
                            </div>
                            {renderTextareaField('prevShiftCompleted', 'Поручения: Выполнено', 'Что было выполнено...')}
                            {renderTextareaField('prevShiftNotCompleted', 'Поручения: Не выполнено', 'Что не было выполнено...')}
                        </fieldset>

                        <fieldset className="mb-6">
                            <legend className="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2 w-full">Безопасность и персонал</legend>
                            {renderRadioGroup('injuries', 'Травматизм и несчастные случаи', [{value: 'не зарегистрировано', label: 'Не зарегистрировано'}, {value: 'зарегистрировано', label: 'Зарегистрировано'}])}
                            {renderRadioGroup('accidents', 'Аварии', [{value: 'не зарегистрировано', label: 'Не зарегистрировано'}, {value: 'зарегистрировано', label: 'Зарегистрировано'}])}
                            {renderRadioGroup('workSafety', 'Отработали', [{value: 'безопасно', label: 'Безопасно'}, {value: 'не безопасно', label: 'Не безопасно'}])}
                            {renderRadioGroup('ltif', 'Ltif равен', [{value: 'нулю', label: 'Нулю'}, {value: 'не равен', label: 'Не равен'}])}
                            {renderRadioGroup('accidentIndex', 'Индекс аварийности', [{value: 'нулю', label: 'Нулю'}, {value: 'не равен', label: 'Не равен'}])}
                             <div className="grid grid-cols-2 gap-4">
                                {renderInputField('shiftOn', 'Человек на смене', '8', 'number')}
                                {renderInputField('shiftTotal', 'Всего в смене', '10', 'number')}
                                {renderInputField('otherShift', 'В другой смене', '1', 'number')}
                                {renderInputField('vacation', 'В отпуске', '1', 'number')}
                                {renderInputField('fromOtherShift', 'Из другой смены', '0', 'number')}
                                {renderInputField('sickLeave', 'На больничном', '0', 'number')}
                            </div>
                            {renderInputField('competenceIndex', 'Индекс компетенции, %', '95')}
                            {renderTextareaField('competenceRisks', 'Риски по индексу компетентности', 'Отсутствуют')}
                        </fieldset>

                        <fieldset className="mb-6">
                            <legend className="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2 w-full">Технические показатели</legend>
                            <div className="grid grid-cols-2 gap-4">
                                {renderInputField('ntrViolations', 'Нарушения НТР', '', 'text')}
                                {renderInputField('nakViolations', 'Нарушения НАК', '', 'text')}
                            </div>
                            {renderTextareaField('recurringEvents', 'Повторяющиеся события, отклонения', 'не обнаружено')}
                            {renderInputField('asutpAlarms', 'Срабатывания сигнализации АСУТП, шт.', '5', 'number')}
                            <div className="grid grid-cols-2 gap-4">
                                {renderInputField('asutpAutoModeDaily', 'Регуляторы АСУТП в авто (сутки)', '98%')}
                                {renderInputField('asutpAutoModeMonthly', 'Регуляторы АСУТП в авто (месяц)', '96%')}
                            </div>
                            {renderRadioGroup('pazActivations', 'Срабатывания ПАЗ', [{value: 'не зарегистрировано', label: 'Не зарегистрировано'}, {value: 'зарегистрировано', label: 'Зарегистрировано'}])}
                            {renderTextareaField('blockerOverrides', 'Отключение блокировок', 'не производилось')}
                        </fieldset>
                        
                        <fieldset>
                             <legend className="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2 w-full">Производственные показатели и доп. информация</legend>
                             {renderRadioGroup('consumptionDeviation', 'Отклонение от расходных норм', [{value: 'не зарегистрировано', label: 'Не зарегистрировано'}, {value: 'зарегистрировано', label: 'Зарегистрировано'}])}
                             <div className="grid grid-cols-2 gap-4 mb-2">
                                 {renderInputField('aoT50actual', 'АО по Т50 (факт)', '', 'number')}
                                 {renderInputField('aoT50plan', 'АО по Т50 (план)', '', 'number')}
                             </div>
                             {renderInputField('aoT50change', 'АО по Т50 (изменение)', 'Убирали __ единицы')}
                             <div className="grid grid-cols-2 gap-4 mt-4 mb-2">
                                 {renderInputField('aoT100actual', 'АО по Т100 (факт)', '', 'number')}
                                 {renderInputField('aoT100plan', 'АО по Т100 (план)', '', 'number')}
                             </div>
                             {renderInputField('aoT100change', 'АО по Т100 (изменение)', 'Добавляли __ единицы')}
                             {renderRadioGroup('vdskConsumption', 'Расход ВДСК', [{value: 'в норме', label: 'В норме'}, {value: 'не в норме', label: 'Не в норме'}])}
                             
                             <div className="mt-4 pt-4 border-t border-gray-700">
                                <h4 className="font-semibold text-gray-200 mb-3">Анализы 1/2 тл</h4>
                                {renderInputField('analysis12_kv', 'К.В.', '', 'number')}
                                {renderInputField('analysis12_loss', 'Потери', '', 'number')}
                                {renderInputField('analysis12_bulk_density', 'Насыпная плотность', '', 'number')}
                                {renderInputField('analysis12_color', 'Цвет', '', 'text')}
                                {renderInputField('analysis12_agglomeration', 'Агломерация', '', 'text')}
                            </div>
                            <div className="mt-4 pt-4 border-t border-gray-700">
                                <h4 className="font-semibold text-gray-200 mb-3">Анализы 3 тл</h4>
                                {renderInputField('analysis3_kv', 'К.В.', '', 'number')}
                                {renderInputField('analysis3_loss', 'Потери', '', 'number')}
                                {renderInputField('analysis3_bulk_density', 'Насыпная плотность', '', 'number')}
                                {renderInputField('analysis3_color', 'Цвет', '', 'text')}
                                {renderInputField('analysis3_agglomeration', 'Агломерация', '', 'text')}
                            </div>

                             {renderRadioGroup('unidentifiedImbalances', 'Неидентифицированные дебалансы', [{value: 'не обнаружено', label: 'Не обнаружено'}, {value: 'обнаружено', label: 'Обнаружено'}])}
                             {renderInputField('greenZoneTime', 'Время в зеленой зоне, %', '99')}
                             {renderTextareaField('ekonsExceptions', 'Показатели ЭкОНС (исключения)', 'Нет')}
                             {renderInputField('suutpEfficiency', 'Эффективность СУУТП, %', '100')}
                             <div className="grid grid-cols-2 gap-4">
                                {renderInputField('dailyProduction12', 'Выработка 1/2 тл', '', 'number')}
                                {renderInputField('dailyProduction3', 'Выработка 3 тл', '', 'number')}
                             </div>

                             <div className="mt-6 pt-6 border-t border-gray-700">
                                <h3 className="text-lg font-semibold text-white mb-4">Сводка по производству СБС</h3>
                                <div className="p-4 border border-gray-700 rounded-lg mb-4">
                                    <h4 className="font-semibold text-gray-200 mb-3">Упаковано за сутки</h4>
                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                        {renderInputField('packedDailyPlan', 'План, т', '117', 'number')}
                                        {renderInputField('packedDailyActual', 'Факт, т', '131', 'number')}
                                        {renderInputField('packedDailyPercentage', 'Выполнение, %', '', 'number', true)}
                                    </div>
                                </div>
                                <div className="p-4 border border-gray-700 rounded-lg mb-4">
                                    <h4 className="font-semibold text-gray-200 mb-3">Паспортизовано за сутки</h4>
                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                        {renderInputField('certifiedDailyPlan', 'План, т', '158', 'number')}
                                        {renderInputField('certifiedDailyActual', 'Факт, т', '253', 'number')}
                                        {renderInputField('certifiedDailyPercentage', 'Выполнение, %', '', 'number', true)}
                                    </div>
                                </div>
                                <div className="p-4 border border-gray-700 rounded-lg mb-4">
                                    <h4 className="font-semibold text-gray-200 mb-3">Паспортизировано с начала месяца</h4>
                                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                                        {renderInputField('certifiedMonthlyPlanCumulative', 'План нараст.', '5561', 'number')}
                                        {renderInputField('certifiedMonthlyActualCumulative', 'Факт нараст.', '5613', 'number')}
                                        {renderInputField('certifiedMonthlyPlanTotal', 'План на месяц', '7318', 'number')}
                                        {renderInputField('certifiedMonthlyPercentage', 'Выполнение, %', '', 'number', true)}
                                    </div>
                                </div>
                                <div className="p-4 border border-gray-700 rounded-lg">
                                    <h4 className="font-semibold text-gray-200 mb-3">Упаковано с начала месяца</h4>
                                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                                        {renderInputField('packedMonthlyPlanCumulative', 'План нараст.', '5548', 'number')}
                                        {renderInputField('packedMonthlyActualCumulative', 'Факт нараст.', '5747', 'number')}
                                        {renderInputField('packedMonthlyPlanTotal', 'План на месяц', '7444', 'number')}
                                        {renderInputField('packedMonthlyPercentage', 'Выполнение, %', '', 'number', true)}
                                    </div>
                                </div>
                            </div>
                            
                             {renderTextareaField('labComments', 'Замечания от лаборатории', 'не было')}
                             {renderTextareaField('downtimeReasons', 'Причины простоев', 'Простоев не было.')}
                             {renderTextareaField('risks', 'Риски', 'Риски отсутствуют.')}
                        </fieldset>
                    </form>
                </div>
                
                {/* Preview Section */}
                <div className="sticky top-8 h-fit print-container">
                     <div className="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 className="text-xl font-semibold text-white mb-4 no-print">Предпросмотр отчета</h2>
                        <div className="h-[calc(100vh-220px)] overflow-y-auto preview-scroll">
                           <ReportPreview formData={formData} />
                        </div>
                        <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2 no-print">
                            <button 
                                onClick={copyToClipboard}
                                className={`w-full font-bold py-2.5 px-4 rounded-lg transition-all duration-300 text-sm ${copyButtonText === 'Скопировано!' ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-700'}`}
                            >
                                {copyButtonText}
                            </button>
                            <button 
                                onClick={handleSaveAsTxt}
                                className="w-full font-bold py-2.5 px-4 rounded-lg transition-colors duration-300 text-sm bg-gray-600 hover:bg-gray-700"
                            >
                                Сохранить в .txt
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    );
};

const container = document.getElementById('root');
const root = createRoot(container!);
root.render(<App />);